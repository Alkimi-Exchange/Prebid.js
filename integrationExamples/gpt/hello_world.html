<!--
  This page calls a single bidder for a single ad slot. It can be considered a "hello world" example for using
  Prebid with the Google Publisher Tag.
  It also makes a good test page for new adapter PR submissions. Simply set your server's Bid Params object in the
  bids array inside the adUnits, and it will use your adapter to load an ad.
  NOTE that many ad servers won't send back an ad if the URL is localhost... so you might need to
  set an alias in your /etc/hosts file so that you can load this page from a different domain.
-->

<!DOCTYPE html>

<head>
    <script async src="../../build/dev/prebid.js"></script>
    <!-- <script async src="https://www.googletagservices.com/tag/js/gpt.js"></script> -->

    <script src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>
    <script src="./sign_utils.js"></script>

    <!-- <style>
        #fluid_nonLinear_ID0 {
            border: 0;
        }

        #close_button_vid1 {
            display: none;
        }
    </style> -->

    <script>
        var FAILSAFE_TIMEOUT = 3300;
        var PREBID_TIMEOUT = 1000;

        var bannerAdUnit1 = {
            code: 'div-gpt-banner1',
            mediaTypes: {
                banner: {
                    sizes: [[300, 250]],
                    battr: [1, 2, 3],
                    btype: [1, 2],
                    pos: 1
                }
            },
            bids: [{
                bidder: 'alkimi',
                params: {
                    // bidFloor: 0.5,
                    instl: 0,
                    exp: 30,
                    // token: 'a6b042a5-2d68-4110-a051-77fbaf002035', // dev
                    token: '972bfdaf-7f9a-4d85-a69d-38946f53b6f6', // localhost
                }
            }, {
                bidder: 'unknown',
                params: {
                    bidFloor: 100,
                    // token: 'a6b042a5-2d68-4110-a051-77fbaf002035', // dev
                    token: '972bfdaf-7f9a-4d85-a69d-38946f53b6f6', // localhost
                }
            }]
        };

        // var bannerAdUnit2 = {
        //     code: 'div-gpt-ad-1460505748561-1',
        //     mediaTypes: {
        //         banner: {
        //             sizes: [[300, 250]],
        //         }
        //     },
        //     bids: [{
        //         bidder: 'alkimi',
        //         params: {
        //             bidFloor: 100,
        //             // token: 'a6b042a5-2d68-4110-a051-77fbaf002035', // dev
        //             token: '7d8aac74-ad7c-4015-9e03-b25beb7b257d', // localhost
        //         }
        //     }]
        // };

        var videoAdUnit = {
            code: 'vid1',
            mediaTypes: {
                video: {
                    playerSize: [[300, 250]],
                    mimes: ["video/mp4"],
                    protocols: [1, 2, 3, 4, 5]
                }
            },
            bids: [{
                bidder: 'alkimi',
                params: {
                    // bidFloor: 0.4,
                    // token: 'a6b042a5-2d68-4110-a051-77fbaf002035', // dev
                    token: '972bfdaf-7f9a-4d85-a69d-38946f53b6f6', // localhost
                }
            }]
        };

        var audioAdUnit = {
            code: 'audio',
            mediaTypes: {
                audio: {
                    sizes: [[300, 250]],
                    mimes: ["audio/mp3"]

                }
            },
            bids: [{
                bidder: 'alkimi',
                params: {
                    bidFloor: 0.4,
                    // token: 'a6b042a5-2d68-4110-a051-77fbaf002035', // dev
                    token: '972bfdaf-7f9a-4d85-a69d-38946f53b6f6', // localhost
                }
            }]
        };

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

    </script>



    <script>
        // var googletag = googletag || {};
        // googletag.cmd = googletag.cmd || [];
        // googletag.cmd.push(function () {
        //     googletag.pubads().disableInitialLoad();
        // });

        // const randomUUID = generateUUID()
        // const bids = checkAdUnitSetup([bannerAdUnit1, videoAdUnit])

        // fetch('http://localhost:8282/bid/sign', {
        //     method: 'POST', body: JSON.stringify({ bids, randomUUID }), headers: {
        //         'Content-Type': 'application/json',
        //         'Accept': 'application/json'
        //     }
        // }).then(response => {
        //     if (response.status !== 200) {
        //         alert('Incorrect request!')
        //     } else {
        //         response.json().then(json => {
        pbjs.que.push(function () {
            pbjs.addAdUnits(bannerAdUnit1);
            // pbjs.addAdUnits(bannerAdUnit2);
            pbjs.addAdUnits(videoAdUnit);
            // pbjs.addAdUnits(audioAdUnit);

            pbjs.setConfig({
                consentManagement: {
                    gdpr: {
                        cmpApi: 'static',
                        consentData: {
                            getTCData: {
                                tcString: 'COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw',
                                gdprApplies: true
                            }
                        }
                    },
                    usp: {
                        cmpApi: 'static',
                        consentData: {
                            getUSPData: {
                                uspString: '1YYY'
                            }
                        }
                    }
                },
                schain: {
                    validation: "strict",
                    config: {
                        ver: "1.0",
                        complete: 0,
                        nodes: [
                            {
                                asi: "indirectseller.com",
                                sid: "00001",
                                hp: 1
                            }
                        ]
                    }
                },
                coppa: 1,
                enableTIDs: true,
                alkimi: {
                //     signature: json.signature,
                //     randomUUID
                    walletID: "test"
                },
                cache: {
                    url: "https://prebid.adnxs.com/pbc/v1/cache"
                },
                floors: {
                    enforcement: {
                        floorDeals: false,
                        bidAdjustment: true
                    },
                    data: {
                        currency: 'USD',
                        modelVersion: 'some setconfig model version',
                        schema: {
                            delimiter: '|',
                            fields: ['mediaType', 'size']
                        },
                        values: {
                            'banner|300x250': 0.5,
                            'banner|300x251': 0.6,
                            'video|*': 0.4,
                            'audio|*': 0.3
                        }
                    }
                },
                ortb2: {
                    site: {
                        page: "https://example2.com/index.html",
                        keywords: "test, test2"
                    },
                    device: {
                        "ua": "userAgent",
                        "ip": "193.168.244.1"
                    },
                    regs: {
                        ext: {
                            gdpr: 0
                        }
                    },
                    at: 2,
                    source: {
                        ext: {
                            full_page_auction: false
                        }
                    },
                    bcat: ["BSW1", "BSW2"],
                    wseat: ["16", "165"]
                },
                // debug: true,
                // s2sConfig: {
                //     accountId: '1001',
                //     bidders: ['alkimi'],
                //     adapter: 'prebidServer',
                //     enabled: true,
                //     endpoint: 'https://prebid-srv.alkimi-onboarding-dev.com/openrtb2/auction',
                //     syncEndpoint: 'http://localhost:8080/cookie_sync',
                //     timeout: 50000,
                //     // syncUrlModifier: {
                //     //     'openx': function (type, url, bidder) {
                //     //         const publisherId = '00000123231231'
                //     //         url += &ri=${publisherId};
                //     //         return url
                //     //     }
                //     // },
                //     extPrebid: {
                //         // cache: {
                //         //     vastxml: { returnCreative: true }
                //         // },
                //         targeting: {
                //             pricegranularity: { "ranges": [{ "max": 40.00, "increment": 1.00 }] }
                //         },
                //         // bidderparams: {
                //         //     alkimi: {
                //         //         signature: json.signature,
                //         //         randomUUID
                //         //     }
                //         // }
                //     }
                // }
            });

            pbjs.requestBids({
                bidsBackHandler: renderAds,
                timeout: PREBID_TIMEOUT
            });
        });
        //         })
        //     }
        // })

        function sendAdserverRequest() {
            if (pbjs.adserverRequestSent) return;
            pbjs.adserverRequestSent = true;
            googletag.cmd.push(function () {
                pbjs.que.push(function () {
                    pbjs.setTargetingForGPTAsync();
                    googletag.pubads().refresh();
                });
            });

            var highestCpmBids = pbjs.getHighestCpmBids('vid1');
            var videoUrl = pbjs.adServers.dfp.buildVideoUrl({
                adUnit: videoAdUnit,
                url: 'https://prebid.adnxs.com/pbc/v1/cache?uuid=' + highestCpmBids[0].videoCacheKey
            });
            invokeVideoPlayer(videoUrl);
        }

        function renderAds() {
            if (pbjs.adserverRequestSent) return;
            pbjs.adserverRequestSent = true;

            var highestCpmBids = pbjs.getHighestCpmBids('div-gpt-banner1');
            if (highestCpmBids[0]) {
                let idIFrame = "div-banner-iframe";
                let iFrame = "<iframe id='" + idIFrame + "'"
                    + "onload=\"resizeIframe(this)\""
                    + " FRAMEBORDER=\"0\""
                    + " SCROLLING=\"no\""
                    + " MARGINHEIGHT=\"0\""
                    + " MARGINWIDTH=\"0\""
                    + " TOPMARGIN=\"0\""
                    + " LEFTMARGIN=\"0\""
                    + " ALLOWTRANSPARENCY=\"true\""
                    + " WIDTH=\"0\""
                    + " HEIGHT=\"0\">."
                    + " </iframe>"

                document.getElementById("div-gpt-banner1").innerHTML = iFrame

                var iframeDoc = document.getElementById(idIFrame).contentWindow.document
                pbjs.renderAd(iframeDoc, highestCpmBids[0].adId);

                let div = document.getElementById('div-gpt-banner1Cpm');
                div.innerHTML = `
                    <div>dspID: ${highestCpmBids[0].creativeId}</div>
                    <div>CPM: ${highestCpmBids[0].cpm}</div>
                `
            }

            highestCpmBids = pbjs.getHighestCpmBids('vid1');
            if (highestCpmBids[0]) {
                pbjs.renderAd(document, highestCpmBids[0].adId)
                var videoUrl = pbjs.adServers.dfp.buildVideoUrl({
                    adUnit: videoAdUnit,
                    url: 'https://prebid.adnxs.com/pbc/v1/cache?uuid=' + highestCpmBids[0].videoCacheKey
                });
                invokeVideoPlayer(videoUrl);

                let div = document.getElementById('vid1Cpm');
                div.innerHTML = `
                    <div>dspID: ${highestCpmBids[0].creativeId}</div>
                    <div>CPM: ${highestCpmBids[0].cpm}</div>
                `
            }
        }

        setTimeout(function () {
            renderAds();
        }, FAILSAFE_TIMEOUT);

    </script>

    <!-- <script>
        googletag.cmd.push(function () {
            googletag.defineSlot('/19968336/header-bid-tag-0', [[300, 250]], 'div-gpt-banner1').addService(googletag.pubads());
            googletag.defineSlot('/19968336/header-bid-tag-1', [[300, 250]], 'vid1').addService(googletag.pubads());

            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script> -->

    <script>
        function resizeIframe(obj) {
            obj.style.height = obj.contentWindow.document.documentElement.scrollHeight + 'px';
            obj.style.width = obj.contentWindow.document.documentElement.scrollWidth + 'px';
        }
    </script>

    <script>

        var page_load_time;

        page_load_time = new Date().getTime() - performance.timing.navigationStart;
        console.log(page_load_time + "ms -- Player loading!");



        page_load_time = new Date().getTime() - performance.timing.navigationStart;
        console.log(page_load_time + "ms -- Player loaded!");

        function invokeVideoPlayer(url) {

            console.log('vast url: ' + url)



            var myFP;
            var vastLoaded;

            var configuration = {
                "onBeforeXMLHttpRequestOpen": (request) => {
                    request.withCredentials = false
                    return request;
                },
                "onBeforeXMLHttpRequest": (request) => {
                    request.withCredentials = false
                    return request;
                },
                "layoutControls": {
                    "loop": false,
                    "controlBar": {
                        "autoHideTimeout": 3,
                        "animated": true,
                        "autoHide": true
                    },
                    "htmlOnPauseBlock": {
                        "html": null,
                        "height": null,
                        "width": null
                    },
                    "autoPlay": false,
                    "mute": true,
                    "allowTheatre": false,
                    "playPauseAnimation": false,
                    "playbackRateEnabled": false,
                    "allowDownload": false,
                    "playButtonShowing": false,
                    "fillToContainer": false,
                    "posterImage": ""
                },
                "vastOptions": {
                    "allowVPAID": true,
                    "adList": [
                        {
                            roll: 'preRoll',
                            vastTag: url,
                            nonlinearDuration: 10,
                        }
                    ],
                    "adCTAText": false,
                    "adCTATextPosition": "",
                    "vastAdvanced": {
                        "vastLoadedCallback": () => {
                            vastLoaded = true;
                        },
                        "noVastVideoCallback": () => {
                            vastLoaded = false;
                        },
                        "vastVideoSkippedCallback": () => { },
                        "vastVideoEndedCallback": () => {
                            // if (vastLoaded) {
                            //     myFP = fluidPlayer('vid1', configuration);
                            //     myFP.play();
                            // }
                        }
                    }
                }
            }

            myFP = fluidPlayer('vid1', configuration);
            myFP.play();

        }

    </script>

    <style>
        #fluid_nonLinear_ID0 {
            display: none;
        }

        /* #close_button_vid1 {
            display: none;
        } */
    </style>

</head>

<body>
    <h2>Alkimi test via prebid.js</h2>
    <div>Banner ad</div>
    <div id="div-gpt-banner1Cpm"></div>
    <div id='div-gpt-banner1'>
        <!-- <script type='text/javascript'>
            googletag.cmd.push(function () { googletag.display('div-gpt-ad-1460505748561-0'); });
        </script> -->
    </div>

    <!-- <h5>Div-2 banner</h5>
    <div id='div-gpt-ad-1460505748561-1'>
        <script type='text/javascript'>
            googletag.cmd.push(function () { googletag.display('div-gpt-ad-1460505748561-1'); });
        </script>
    </div> -->
    <br/>
    <div>Video ad</div>
    <div id="vid1Cpm"></div>
    <video id="vid1" width='640' height='480' muted>
        <!-- <source src="https://cdn.visualidx.com/media/video/one_second_blank.m4v" type='video/mp4' /> -->
        <!-- <source src="http://vjs.zencdn.net/v/oceans.mp4" type='video/mp4' /> -->
    </video>

    <!-- <script>
        const bids = checkAdUnitSetup([bannerAdUnit1, videoAdUnit])
        function getDirectBanner() {
            const bannerContainer = document.getElementById('div-gpt-ad-1460505748561-0')
            fetch('http://localhost:8055/bid?prebid=false', { method: 'POST', body: JSON.stringify({ signRequest: { bids }, bidIds: ['div-gpt-ad-1460505748561-0', 'vid1'] }), headers: { 'Rtb-Direct': true } }).then(function (response) {
                if (response.status === 200) {
                    response.json().then(function (json) {
                        let idIFrame = "div-banner-iframe";
                        let iFrame = "<iframe id='" + idIFrame + "'"
                            + "onload=\"resizeIframe(this)\""
                            + " FRAMEBORDER=\"0\""
                            + " SCROLLING=\"no\""
                            + " MARGINHEIGHT=\"0\""
                            + " MARGINWIDTH=\"0\""
                            + " TOPMARGIN=\"0\""
                            + " LEFTMARGIN=\"0\""
                            + " ALLOWTRANSPARENCY=\"true\""
                            + " WIDTH=\"0\""
                            + " HEIGHT=\"0\">."
                            + " </iframe>"

                        document.getElementById("div-gpt-ad-1460505748561-0").innerHTML = iFrame

                        var iframeDoc = document.getElementById(idIFrame).contentWindow.document





                        let iframe = document.createElement('iframe');
                        iframe.width = 300
                        iframe.height = 250
                        iframe.frameBorder = 0
                        iframe.marginWidth = 0
                        iframe.marginHeight = 0
                        iframe.src = json.prebidResponse.find(resp => resp.impId = 'div-gpt-ad-1460505748561-0').ad
                        bannerContainer.appendChild(iframe);
                    });
                }
            });
        }

        getDirectBanner()
    </script> -->

    <div id='audio'>

    </div>

</body>

</html>
